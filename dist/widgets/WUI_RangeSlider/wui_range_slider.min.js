var WUI_RangeSlider=new function(){"use strict";var a={},b=null,c=null,d=null,e=null,f="_wui_container",g="background-color: #ff0000",h="background-color: #00ff00",i=null,j={},k={hook:"wui-rangeslider-hook",bar:"wui-rangeslider-bar",filler:"wui-rangeslider-filler",hook_focus:"wui-rangeslider-hook-focus",value_input:"wui-rangeslider-input"},l={width:148,height:8,title:"",title_min_width:0,value_min_width:0,min:0,max:1,step:.01,scroll_step:.01,vertical:!1,title_on_top:!1,on_change:null,default_value:.5,bar:!0,midi:null,configurable:null},m={min:0,max:0,step:0,scroll_step:0},n=function(a){var b=a.ownerDocument,c=a.getBoundingClientRect(),d=b.body,e=b.documentElement,f=b.defaultView||b.parentWindow,g=f.pageYOffset||e.scrollTop||d.scrollTop,h=f.pageXOffset||e.scrollLeft||d.scrollLeft,i=e.clientTop||d.clientTop||0,j=e.clientLeft||d.clientLeft||0,k=c.top+g-i,l=c.left+h-j;return{top:Math.round(k),left:Math.round(l)}},o=function(a,b){null!==a&&a(b)},p=function(a,b){var c=""+a,d=c.indexOf("."),e=-1==d?c.length:1+d+b,f=c.substr(0,e),g=isNaN(f)?0:f;return parseFloat(g)},q=function(a){return a.classList.contains(k.hook)?a:a.classList.contains(k.filler)?a.firstElementChild:a.firstElementChild.firstElementChild},r=function(b,c,d){var e,f,g,h,i=b,j=a[i.id],l=c.opts.width,m=c.opts.height,n=Math.abs((d-c.opts.min)/c.opts.range);e=i.getElementsByClassName(k.bar)[0],f=e.firstElementChild,g=f.firstElementChild,h=e.nextElementSibling,d=p(d,4),c.opts.vertical?(n=Math.round(n*e.offsetHeight),f.style.position="absolute",f.style.bottom="0",f.style.width="100%",f.style.height=n+"px",g.style.marginTop=-l+"px",g.style.marginLeft=-l/2-1+"px",g.style.width=2*l+"px",g.style.height=2*l+"px",h.style.marginTop="13px",j.element!==i&&(j.filler.style.position="absolute",j.filler.style.bottom="0",j.filler.style.width="100%",j.filler.style.height=n+"px",j.hook.style.marginTop=-l+"px",j.hook.style.marginLeft=-l/2-1+"px",j.hook.style.width=2*l+"px",j.hook.style.height=2*l+"px",j.value_input.style.marginTop="13px")):(n=Math.round(n*l),f.style.width=n+"px",f.style.height="100%",g.style.left=n+"px",g.style.marginTop=-m/2+"px",g.style.marginLeft=-m+"px",g.style.width=2*m+"px",g.style.height=2*m+"px",j.element!==i&&(j.filler.style.width=n+"px",j.filler.style.height="100%",j.hook.style.left=n+"px",j.hook.style.marginTop=-m/2+"px",j.hook.style.marginLeft=-m+"px",j.hook.style.width=2*m+"px",j.hook.style.height=2*m+"px")),j.value_input.value=d,h.value=d,c.value=d},s=function(a){if(a.preventDefault(),null!==d){var f,g,h=d.parentElement,i=h.parentElement,j=i.nextElementSibling,k=n(i),l=i.offsetWidth,m=0,q=a.clientX,r=a.clientY,s=a.changedTouches,t=null;if(s)for(f=0;s.length>f;f+=1)if(t=s[f],t.identifier===e){q=s[f].clientX,r=s[f].clientY;break}if(c.opts.vertical?(l=i.offsetHeight,m=Math.round((k.top+i.offsetHeight-r)/c.opts.step)*c.opts.step):m=Math.round((q-k.left)/c.opts.step)*c.opts.step,m>l?(m=l,b=c.opts.max):0>m?(m=0,b=c.opts.min):b=Math.round((c.opts.min+m/l*c.opts.range)/c.opts.step)*c.opts.step,c.value===b)return;c.value=b,g=p(b,4),j.value=g,c.value_input.value=g,c.opts.vertical?(h.style.height=m+"px",c.filler.style.height=m+"px"):(h.style.width=m+"px",c.filler.style.width=m+"px",d.style.left=m+"px",c.hook.style.left=m+"px"),o(c.opts.on_change,b)}},t=function(a){if(d){a.preventDefault();var b,f=a.changedTouches,g=null,h=!1,i=d.ownerDocument,j=i.defaultView||i.parentWindow;if(f){for(b=0;f.length>b;b+=1)if(g=f[b],g.identifier===e){h=!0,j.removeEventListener("touchend",t,!1),j.removeEventListener("touchmove",s,!1);break}}else h=!0,j.removeEventListener("mouseup",t,!1),j.removeEventListener("mousemove",s,!1);h&&(d.classList.remove(k.hook_focus),d=null,c=null,i.body.style.cursor="default")}},u=function(b){b.preventDefault(),b.stopPropagation();var f,g,h=null,i=!1,j=b.changedTouches;null===c&&j&&(e=j[0].identifier,i=!0),0===b.button&&(i=!0),i&&(d=q(b.target),d.classList.add(k.hook_focus),h=d.parentElement.parentElement.parentElement,c=a[h.id],f=h.ownerDocument,g=f.defaultView||f.parentWindow,f.body.style.cursor="pointer",s(b),g.addEventListener("mousemove",s,!1),g.addEventListener("touchmove",s,!1),g.addEventListener("mouseup",t,!1),g.addEventListener("touchend",t,!1))},v=function(b){b.preventDefault(),b.stopPropagation();var c=b.target,d=c.parentElement.parentElement.parentElement,e=a[d.id],f=e.opts.default_value;r(d,e,f),o(e.opts.on_change,f)},w=function(b){b.preventDefault(),b.stopPropagation();var c=q(b.target),d=c.parentElement.parentElement.parentElement,e=a[d.id],f=b.wheelDelta?b.wheelDelta/40:b.detail?-b.detail:0,g=e.value;f>=0?g+=e.opts.scroll_step:g-=e.opts.scroll_step,g>e.opts.max?g=e.opts.max:e.opts.min>g&&(g=e.opts.min),r(d,e,g),o(e.opts.on_change,g)},x=function(b){if(!b.target.validity||b.target.validity.valid){var c=b.target.parentElement.childNodes[1];if(void 0!==c){var d=q(c),e=d.parentElement.parentElement.parentElement,f=a[e.id];r(e,f,b.target.value),o(f.opts.on_change,b.target.value)}}},y=function(a,b,c){return function(a){var d=a.target,e=b.opts;(!d.validity||d.validity.valid)&&("min"===c?(e.min=p(d.value,4),b.value_input.min=e.min,e.range=e.max-e.min):"max"===c?(e.max=p(d.value,4),b.value_input.max=e.max,e.range=e.max-e.min):"step"===c?(e.step=p(d.value,4),b.value_input.step=e.step):"scroll_step"===c&&(e.scroll_step=p(d.value,4)),void 0!==e.configurable[c]&&(e.configurable[c].val=d.value))}},z=function(b){b.preventDefault(),b.stopPropagation();var c,d,e=b.target,f=e.parentElement,g=a[f.id];if(g.midi.learn)return g.midi.learn=!1,e.style="",void(i=null);for(c in a)a.hasOwnProperty(c)&&(d=a[c],d.midi.learn=!1,d.midi.learn_elem&&(d.midi.learn_elem.style=""));g.midi.learn=!0,e.style=h,i=f.id},A=function(b){b.preventDefault(),b.stopPropagation();var c,d,e,g,h,i,j,l,o=b.target,p=o.parentElement,q=a[p.id],r=q.opts,s=o.ownerDocument,t=q.element.id+f,u=1;if(document.getElementById(t)||(q.configure_panel_open=!1),q.configure_panel_open!==!0){h=s.createElement("div"),h.className="wui-rangeslider-configure-container",l=s.createElement("div"),l.className="wui-rangeslider-configure-close",c=function(a){q.configure_panel_open=!1;var b=document.getElementById(t),c=a.target.ownerDocument.getElementById(t);b&&b.parentElement&&b.parentElement.removeChild(b),c&&c.parentElement&&c.parentElement.removeChild(c)},l.addEventListener("click",c,!1),l.addEventListener("touchstart",c,!1),h.id=t,h.appendChild(l);for(e in r.configurable)r.configurable.hasOwnProperty(e)&&void 0!==m[e]&&(g=r.configurable[e],i=s.createElement("div"),i.style.display="inline-block",i.style.marginRight="8px",i.style.width="80px",i.style.textAlign="right",i.innerHTML=e.replace("_"," ")+" : ",j=s.createElement("input"),j.className=k.value_input,h.appendChild(i),h.appendChild(j),u%2===0&&h.appendChild(s.createElement("div")),j.setAttribute("type","number"),void 0!==g&&(void 0!==g.min&&(j.setAttribute("min",g.min),j.title=j.title+" min: "+g.min),void 0!==g.max&&(j.setAttribute("max",g.max),j.title=j.title+" max: "+g.max),void 0!==g.val?j.setAttribute("value",g.val):"min"===e?j.setAttribute("value",r.min):"max"===e?j.setAttribute("value",r.max):"step"===e?j.setAttribute("value",r.step):"scroll_step"===e&&j.setAttribute("value",r.scroll_step)),j.addEventListener("input",y(b,q,e),!1),u+=1);d=n(o),p.insertBefore(h,o),q.configure_panel_open=!0}},B=function(){console.log("WUI_RangeSlider 'create' failed, first argument not an id nor a DOM element.")};this.create=function(b,c){var d,e,f={};if("string"==typeof b)d=document.getElementById(b);else{if("object"!=typeof b)return void B();if("string"!=typeof b.innerHTML)return void B();d=b,b=d.id}if(void 0!==a[b])return void console.log("WUI_RangeSlider id '"+b+"' already created, aborting.");for(e in l)l.hasOwnProperty(e)&&(f[e]=l[e]);if(void 0!==c){for(e in c)c.hasOwnProperty(e)&&void 0!==l[e]&&(f[e]=c[e]);void 0!==c.max&&(f.range=c.max),void 0!==c.step&&(f.step=c.step,void 0===c.scroll_step&&(f.scroll_step=f.step)),void 0!==c.title_on_top?f.title_on_top=c.title_on_top:f.vertical&&(f.title_on_top=!0),void 0!==c.default_value?f.default_value=c.default_value:void 0!==c.min&&void 0!==c.max&&(f.default_value=f.min+f.max/2)}0>f.min&&(f.range=f.max-f.min),a[b]=null,d.classList.add("wui-rangeslider"),f.title_on_top&&d.classList.add("wui-rangeslider-title-ontop");var g=document.createElement("div"),h=document.createElement("div"),i=document.createElement("div"),j=document.createElement("div"),n=document.createElement("div"),o=document.createElement("input"),p={element:d,opts:f,bar:null,filler:null,hook:null,endless:!1,midi:{device:null,controller:null,ctrl_type:"abs",learn:!1,learn_elem:null},value_input:o,value:f.default_value};if(g.innerHTML=f.title,o.setAttribute("value",f.default_value),o.setAttribute("type","number"),o.setAttribute("step",f.step),o.classList.add(k.value_input),n.classList.add("wui-rangeslider-value"),g.classList.add("wui-rangeslider-title"),h.classList.add(k.bar),i.classList.add(k.filler),j.classList.add(k.hook),f.vertical&&(g.style.textAlign="center"),g.style.minWidth=f.title_min_width+"px",n.style.minWidth=f.value_min_width+"px",o.style.minWidth=f.value_min_width+"px",h.style.width=f.width+"px",h.style.height=f.height+"px",d.appendChild(g),f.bar?(o.setAttribute("min",f.min),o.setAttribute("max",f.max)):(h.style.display="none",o.style.marginTop="6px",c.max&&o.setAttribute("min",f.min),c.min&&o.setAttribute("max",f.max)),h.appendChild(i),i.appendChild(j),d.appendChild(h),p.bar=h,p.filler=i,p.hook=j,d.appendChild(o),c.max||c.min||(p.endless=!0),f.configurable){var q=0;for(e in f.configurable)f.configurable.hasOwnProperty(e)&&void 0!==m[e]&&(q+=1);if(q>0){var s=document.createElement("div");s.classList.add("wui-rangeslider-configurable-btn"),s.addEventListener("click",A,!1),s.addEventListener("touchstart",A,!1),f.title_on_top&&!f.vertical?(s.style.bottom="0",g.style.marginBottom="4px"):f.title_on_top&&f.vertical?(g.style.marginLeft="16px",g.style.marginRight="16px",s.style.top="0"):(g.style.marginLeft="16px",s.style.top="0"),f.vertical?d.appendChild(s):d.insertBefore(s,g)}}if(f.midi)if(navigator.requestMIDIAccess){var t=document.createElement("div");t.classList.add("wui-rangeslider-midi-learn-btn"),t.addEventListener("click",z,!1),t.addEventListener("touchstart",z,!1),p.midi.learn_elem=t,f.midi.type&&(p.midi.ctrl_type=f.midi.type),d.appendChild(t)}else console.log("WUI_RangeSlider id '"+b+"' : Web MIDI API is disabled. (not supported by your browser?)");return f.bar&&(h.addEventListener("mousedown",u,!1),h.addEventListener("touchstart",u,!1),j.addEventListener("dblclick",v,!1),h.addEventListener("mousewheel",w,!1),h.addEventListener("DOMMouseScroll",w,!1)),o.addEventListener("input",x,!1),a[b]=p,r(d,p,f.default_value),b},this.destroy=function(b){var c,d,e,g=a[b];return void 0===g?void console.log("Element id '"+b+"' is not a WUI_RangeSlider, destroying aborted."):(c=g.element,c.parentElement.removeChild(c),d=c.ownerDocument,e=d.getElementById(b+f),e&&d.removeChild(e),void delete a[b])},this.submitMIDIMessage=function(b){var c,d,e,f=b.data[0],h=b.data[1],k=parseInt(b.data[2],10),l="d"+f,m="c"+h,n=0;if(i)return c=a[i],j[l]||(j[l]={}),j[l][m]||(j[l][m]={prev_value:k,widgets:[],increments:1}),j[l][m].widgets.push(i),c.midi.learn=!1,c.midi.learn_elem.style=g,c.midi.learn_elem.title=l+" "+m,void(i=null);if(j[l]&&j[l][m])for(d=j[l][m],n=0;d.widgets.length>n;n+=1)if(c=a[d.widgets[n]],"abs"===c.midi.ctrl_type)e=c.opts.min+c.opts.range*(k/127),r(c.element,c,e),o(c.opts.on_change,e);else if("rel"===c.midi.ctrl_type){if(d.prev_value>k){if(d.increments=-c.opts.step,e=c.value-c.opts.step,c.opts.min>e&&!c.endless)continue;d.prev_value=k}else if(k>d.prev_value){if(d.increments=c.opts.step,e=c.value+c.opts.step,e>c.opts.max&&!c.endless)continue;d.prev_value=k}else if(e=c.value+d.increments,!c.endless){if(e>c.opts.max)continue;if(c.opts.min>e)continue}r(c.element,c,e),o(c.opts.on_change,e)}}},WUI_Input=WUI_RangeSlider;