var WUI_RangeSlider=new function(){"use strict";var a={},b=null,c=null,d=null,e=null,f="_wui_container",g="background-color: #00ff00",h=null,i={},j={midi_learn_btn:"MIDI learn"},k={hook:"wui-rangeslider-hook",bar:"wui-rangeslider-bar",filler:"wui-rangeslider-filler",hook_focus:"wui-rangeslider-hook-focus",value_input:"wui-rangeslider-input",midi_learn_btn:"wui-rangeslider-midi-learn-btn"},l={width:148,height:8,title:"",title_min_width:0,value_min_width:0,min:0,max:1,decimals:4,step:.01,scroll_step:.01,vertical:!1,title_on_top:!1,on_change:null,default_value:0,value:0,bar:!0,midi:null,configurable:null},m={min:0,max:0,step:0,scroll_step:0},n={opts:{},endless:!1,midi:{},value:0},o=function(a){for(var b,c,d=document.getElementById(a);d;){if(d.classList&&d.classList.contains("wui-dialog")){b=d.id;break}d=d.parentNode}return WUI_Dialog&&(c=WUI_Dialog.getDetachedDialog(b))?c.document.getElementById(a):null},p=function(a){var b=a.ownerDocument,c=a.getBoundingClientRect(),d=b.body,e=b.documentElement,f=b.defaultView||b.parentWindow,g=f.pageYOffset||e.scrollTop||d.scrollTop,h=f.pageXOffset||e.scrollLeft||d.scrollLeft,i=e.clientTop||d.clientTop||0,j=e.clientLeft||d.clientLeft||0,k=c.top+g-i,l=c.left+h-j;return{top:Math.round(k),left:Math.round(l)}},q=function(a,b){null!==a&&a(b)},r=function(a,b){var c=(+a).toFixed(b+1);return+c.slice(0,c.length-1)},s=function(a){return a.classList.contains(k.hook)?a:a.classList.contains(k.filler)?a.firstElementChild:a.firstElementChild?a.firstElementChild.firstElementChild:null},t=function(b,c,d){var e,f,g,h,i=b,j=a[i.id],l=c.opts.width,m=c.opts.height,n=Math.abs((d-c.opts.min)/c.opts.range);e=i.getElementsByClassName(k.bar)[0],f=e.firstElementChild,g=f.firstElementChild,h=e.nextElementSibling,d=r(d,j.opts.decimals),c.opts.vertical?(n=Math.round(n*e.offsetHeight),f.style.position="absolute",f.style.bottom="0",f.style.width="100%",f.style.height=n+"px",g.style.marginTop=-l+"px",g.style.marginLeft=-l/2-1+"px",g.style.width=2*l+"px",g.style.height=2*l+"px",h.style.marginTop="13px",j.element!==i&&(j.filler.style.position="absolute",j.filler.style.bottom="0",j.filler.style.width="100%",j.filler.style.height=n+"px",j.hook.style.marginTop=-l+"px",j.hook.style.marginLeft=-l/2-1+"px",j.hook.style.width=2*l+"px",j.hook.style.height=2*l+"px",j.value_input.style.marginTop="13px")):(n=Math.round(n*l),f.style.width=n+"px",f.style.height="100%",g.style.left=n+"px",g.style.marginTop=-m/2+"px",g.style.marginLeft=-m+"px",g.style.width=2*m+"px",g.style.height=2*m+"px",j.element!==i&&(j.filler.style.width=n+"px",j.filler.style.height="100%",j.hook.style.left=n+"px",j.hook.style.marginTop=-m/2+"px",j.hook.style.marginLeft=-m+"px",j.hook.style.width=2*m+"px",j.hook.style.height=2*m+"px")),j.value_input.value=d,h.value=d,c.value=d},u=function(a){if(a.preventDefault(),null!==d){var f,g,h=d.parentElement,i=h.parentElement,j=i.nextElementSibling,k=p(i),l=i.offsetWidth,m=0,n=a.clientX,o=a.clientY,s=a.changedTouches,t=null;if(s)for(f=0;f<s.length;f+=1)if(t=s[f],t.identifier===e){n=s[f].clientX,o=s[f].clientY;break}if(c.opts.vertical?(l=i.offsetHeight,m=Math.round((k.top+i.offsetHeight-o)/c.opts.step)*c.opts.step):m=Math.round((n-k.left)/c.opts.step)*c.opts.step,m>l?(m=l,b=c.opts.max):m<0?(m=0,b=c.opts.min):b=Math.round((c.opts.min+m/l*c.opts.range)/c.opts.step)*c.opts.step,c.value===b)return;c.value=b,g=r(b,c.opts.decimals),j.value=g,c.value_input.value=g,c.opts.vertical?(h.style.height=m+"px",c.filler.style.height=m+"px"):(h.style.width=m+"px",c.filler.style.width=m+"px",d.style.left=m+"px",c.hook.style.left=m+"px"),q(c.opts.on_change,b)}},v=function(a){if(d){a.preventDefault();var b,f=a.changedTouches,g=null,h=!1,i=d.ownerDocument,j=i.defaultView||i.parentWindow;if(f){for(b=0;b<f.length;b+=1)if(g=f[b],g.identifier===e){h=!0,j.removeEventListener("touchend",v,!1),j.removeEventListener("touchmove",u,!1);break}}else h=!0,j.removeEventListener("mouseup",v,!1),j.removeEventListener("mousemove",u,!1);h&&(d.classList.remove(k.hook_focus),d=null,c=null,i.body.style.cursor="default")}},w=function(b){b.stopPropagation();var f,g,h=null,i=!1,j=b.changedTouches;null===c&&j&&(e=j[0].identifier,i=!0),0===b.button&&(i=!0),i&&(d=s(b.target),d.classList.add(k.hook_focus),h=d.parentElement.parentElement.parentElement,c=a[h.id],f=h.ownerDocument,g=f.defaultView||f.parentWindow,f.body.style.cursor="pointer",u(b),g.addEventListener("mousemove",u,!1),g.addEventListener("touchmove",u,!1),g.addEventListener("mouseup",v,!1),g.addEventListener("touchend",v,!1))},x=function(b){b.preventDefault(),b.stopPropagation();var c=b.target,d=c.parentElement.parentElement.parentElement,e=a[d.id],f=e.opts.default_value;t(d,e,f),q(e.opts.on_change,f)},y=function(b){b.preventDefault(),b.stopPropagation();var c,d,e,f,g=b.wheelDelta?b.wheelDelta/40:b.detail?-b.detail:0;b.deltaY&&(g=-b.deltaY),c=s(b.target),null===c?(d=b.target.parentElement,e=a[d.id]):(d=c.parentElement.parentElement.parentElement,e=a[d.id]),f=parseFloat(e.value),g>=0?f+=e.opts.scroll_step:f-=e.opts.scroll_step,e.endless||(e.opts.max&&f>e.opts.max?f=e.opts.max:f<e.opts.min&&(f=e.opts.min)),t(d,e,f),q(e.opts.on_change,f)},z=function(b){if(!b.target.validity||b.target.validity.valid){var c=b.target.parentElement,d=a[c.id];t(c,d,b.target.value),q(d.opts.on_change,b.target.value)}},A=function(a,b,c){return function(a){var d=a.target,e=b.opts;return d.validity&&!d.validity.valid?void("min"===c||"max"===c?b.endless=!0:"step"===c&&(b.value_input.step="any")):("min"===c?(e.min=r(d.value,e.decimals),b.value_input.min=e.min,e.range=e.max-e.min,b.endless=!1):"max"===c?(e.max=r(d.value,e.decimals),b.value_input.max=e.max,e.range=e.max-e.min,b.endless=!1):"step"===c?(e.step=r(d.value,e.decimals),b.value_input.step=e.step):"scroll_step"===c&&(e.scroll_step=r(d.value,e.decimals)),void(void 0!==e.configurable[c]&&(e.configurable[c].val=d.value)))}},B=function(a){var b,c,d,e,f;if(a)for(b in i)for(c in i[b])for(d=i[b][c],f=0;f<d.widgets.length;f+=1)if(e=d.widgets[f],e===a)return void d.widgets.splice(f,1)},C=function(b){b.preventDefault(),b.stopPropagation();var c,d,e,f,i=b.target,l=i.parentElement,m=a[l.id];if(m.learn)return m.learn=!1,i.style="",i.title=j.midi_learn_btn,m.learn_elem.title=j.midi_learn_btn,h=null,m.midi.device=null,m.midi.controller=null,void B(l.id);for(d in a)a.hasOwnProperty(d)&&(e=a[d],e.learn=!1,c=o(d),c&&(f=c.getElementsByClassName(k.midi_learn_btn),f.length>0&&(f[0].style="")),e.learn_elem&&(e.learn_elem.style=""));m.learn=!0,i.style=g,h=l.id},D=function(b){b.preventDefault(),b.stopPropagation();var c,d,e,g,h,i,j,l,n=b.target,o=n.parentElement,q=a[o.id],r=q.opts,s=n.ownerDocument,t=q.element.id+f,u=1;if(document.getElementById(t)||(q.configure_panel_open=!1),q.configure_panel_open!==!0){h=s.createElement("div"),h.className="wui-rangeslider-configure-container",l=s.createElement("div"),l.className="wui-rangeslider-configure-close",c=function(a){q.configure_panel_open=!1;var b=document.getElementById(t),c=a.target.ownerDocument.getElementById(t);b&&b.parentElement&&b.parentElement.removeChild(b),c&&c.parentElement&&c.parentElement.removeChild(c)},l.addEventListener("click",c,!1),l.addEventListener("touchstart",c,!1),h.id=t,h.appendChild(l);for(e in r.configurable)r.configurable.hasOwnProperty(e)&&void 0!==m[e]&&(g=r.configurable[e],i=s.createElement("div"),i.style.display="inline-block",i.style.marginRight="8px",i.style.width="80px",i.style.textAlign="right",i.innerHTML=e.replace("_"," ")+" : ",j=s.createElement("input"),j.className=k.value_input,h.appendChild(i),h.appendChild(j),u%2===0&&h.appendChild(s.createElement("div")),j.setAttribute("type","number"),j.setAttribute("step","any"),void 0!==g&&(void 0!==g.min&&(j.setAttribute("min",g.min),j.title=j.title+" min: "+g.min),void 0!==g.max&&(j.setAttribute("max",g.max),j.title=j.title+" max: "+g.max),void 0!==g.val?j.setAttribute("value",g.val):"min"===e?j.setAttribute("value",r.min):"max"===e?j.setAttribute("value",r.max):"step"===e?j.setAttribute("value",r.step):"scroll_step"===e&&j.setAttribute("value",r.scroll_step)),j.addEventListener("input",A(b,q,e),!1),u+=1);d=p(n),o.insertBefore(h,n),q.configure_panel_open=!0}},E=function(){console.log("WUI_RangeSlider 'create' failed, first argument not an id nor a DOM element.")};this.create=function(b,c){var d,e,f,g={};if("string"==typeof b)d=document.getElementById(b);else{if("object"!=typeof b)return void E();if("string"!=typeof b.innerHTML)return void E();d=b,b=d.id}if(void 0!==a[b])return void console.log("WUI_RangeSlider id '"+b+"' already created, aborting.");for(f in l)l.hasOwnProperty(f)&&(g[f]=l[f]);if(void 0!==c){for(f in c)c.hasOwnProperty(f)&&void 0!==l[f]&&(g[f]=c[f]);void 0!==c.max&&(g.range=c.max),void 0!==c.step&&(g.step=c.step,void 0===c.scroll_step&&(g.scroll_step=g.step)),void 0!==c.title_on_top?g.title_on_top=c.title_on_top:g.vertical&&(g.title_on_top=!0),void 0!==c.default_value?g.default_value=c.default_value:void 0!==c.min&&void 0!==c.max&&(g.default_value=g.min+g.max/2)}g.min<0&&(g.range=g.max-g.min),a[b]=null,d.classList.add("wui-rangeslider"),g.title_on_top&&d.classList.add("wui-rangeslider-title-ontop");var h=document.createElement("div"),i=document.createElement("div"),n=document.createElement("div"),o=document.createElement("div"),p=document.createElement("div"),r=document.createElement("input"),s={element:d,opts:g,bar:null,filler:null,hook:null,endless:!1,midi:{device:null,controller:null,ctrl_type:"abs"},learn:!1,learn_elem:null,value_input:r,default_value:g.default_value,value:g.value};if(h.innerHTML=g.title,r.setAttribute("value",g.value),r.setAttribute("type","number"),r.setAttribute("step",g.step),r.classList.add(k.value_input),p.classList.add("wui-rangeslider-value"),h.classList.add("wui-rangeslider-title"),i.classList.add(k.bar),n.classList.add(k.filler),o.classList.add(k.hook),g.vertical&&(h.style.textAlign="center"),h.style.minWidth=g.title_min_width+"px",p.style.minWidth=g.value_min_width+"px",r.style.minWidth=g.value_min_width+"px",i.style.width=g.width+"px",i.style.height=g.height+"px",d.appendChild(h),g.bar||(i.style.display="none",r.style.marginTop="6px"),c.hasOwnProperty("min")?r.setAttribute("min",g.min):g.min=void 0,c.hasOwnProperty("max")?r.setAttribute("max",g.max):(g.max=void 0,void 0===g.min&&(s.endless=!0)),i.appendChild(n),n.appendChild(o),d.appendChild(i),s.bar=i,s.filler=n,s.hook=o,d.appendChild(r),g.configurable){var u=0;for(f in g.configurable)g.configurable.hasOwnProperty(f)&&void 0!==m[f]&&(u+=1);if(u>0){var v=document.createElement("div");v.classList.add("wui-rangeslider-configurable-btn"),v.addEventListener("click",D,!1),v.addEventListener("touchstart",D,!1),g.title_on_top&&!g.vertical?(v.style.bottom="0",h.style.marginBottom="4px"):g.title_on_top&&g.vertical?(h.style.marginLeft="16px",h.style.marginRight="16px",v.style.top="0"):(h.style.marginLeft="16px",v.style.top="0"),g.vertical?d.appendChild(v):d.insertBefore(v,h)}}if(g.midi)if(navigator.requestMIDIAccess){var A=document.createElement("div");A.classList.add(k.midi_learn_btn),A.title=j.midi_learn_btn,A.addEventListener("click",C,!1),A.addEventListener("touchstart",C,!1),s.learn_elem=A,g.midi.type&&(s.midi.ctrl_type=g.midi.type),d.appendChild(A)}else console.log("WUI_RangeSlider id '"+b+"' : Web MIDI API is disabled. (not supported by your browser?)");return e="onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll",g.bar?(i.addEventListener("mousedown",w,!1),i.addEventListener("touchstart",w,!1),i.addEventListener(e,y,!1),o.addEventListener("dblclick",x,!1)):r.addEventListener(e,y,!1),r.addEventListener("input",z,!1),a[b]=s,t(d,s,g.value),q(s.opts.on_change,s.value),b},this.destroy=function(b){var c,d,e,g=a[b];return void 0===g?void console.log("Element id '"+b+"' is not a WUI_RangeSlider, destroying aborted."):(h===b&&(midi_learn_current=null),B(b),c=g.element,c.parentElement.removeChild(c),d=c.ownerDocument,e=d.getElementById(b+f),e&&d.removeChild(e),void delete a[b])},this.getParameters=function(b){var c,d=a[b],e={};if(void 0===d)return console.log("Element id '"+b+"' is not a WUI_RangeSlider, getParameters aborted."),null;for(c in d)d.hasOwnProperty(c)&&void 0!==n[c]&&(e[c]=d[c]);return e},this.setParameters=function(b,c,d){var e,f=a[b];if(void 0===f)return void console.log("Element id '"+b+"' is not a WUI_RangeSlider, setParameters aborted.");if(c){for(e in f)f.hasOwnProperty(e)&&void 0!==c[e]&&(f[e]=c[e]);f.midi.device&&f.midi.controller&&i["d"+f.midi.device]["c"+f.midi.controller].widgets.push(b),t(f.element,f,f.value),d&&q(f.opts.on_change,f.value)}},this.setValue=function(b,c,d){var e=a[b];return void 0===e?void console.log("Element id '"+b+"' is not a WUI_RangeSlider, setParameters aborted."):(t(e.element,e,c),void(d&&q(e.opts.on_change,c)))},this.submitMIDIMessage=function(b){var c,d,e,f,g,j,l=h,m=b.data[0],n=b.data[1],p=parseInt(b.data[2],10),r="d"+m,s="c"+n,u=0;if(h)return c=a[l],i[r]||(i[r]={}),i[r][s]||(i[r][s]={prev_value:p,widgets:[],increments:1}),i[r][s].widgets.push(l),g=o(l),g&&(e=g.getElementsByClassName(k.midi_learn_btn),e.length>0&&(e[0].style="",e[0].title=r+" "+s)),c.midi.device=m,c.midi.controller=n,c.learn=!1,c.learn_elem.style="",c.learn_elem.title=r+" "+s,void(h=null);if(i[r]&&i[r][s])for(d=i[r][s],u=0;u<d.widgets.length;u+=1)if(l=d.widgets[u],c=a[l],g=o(l),f=g?g:c.element,"abs"===c.midi.ctrl_type)j=c.opts.min+c.opts.range*(p/127),t(f,c,j),q(c.opts.on_change,j);else if("rel"===c.midi.ctrl_type){var v=c.opts.step;if("any"===v&&(v=.5),d.prev_value>p){if(d.increments=-v,j=c.value-v,j<c.opts.min&&!c.endless)continue;d.prev_value=p}else if(d.prev_value<p){if(d.increments=v,j=c.value+v,j>c.opts.max&&!c.endless)continue;d.prev_value=p}else if(j=c.value+d.increments,!c.endless){if(j>c.opts.max)continue;if(j<c.opts.min)continue}t(f,c,j),q(c.opts.on_change,j)}}},WUI_Input=WUI_RangeSlider;