var WUI_RangeSlider=new function(){"use strict";var a={},b=null,c=null,d=null,e=null,f="_wui_container",g="background-color: #00ff00",h=null,i={},j={midi_learn_btn:"MIDI learn"},k={hook:"wui-rangeslider-hook",bar:"wui-rangeslider-bar",filler:"wui-rangeslider-filler",hook_focus:"wui-rangeslider-hook-focus",value_input:"wui-rangeslider-input",midi_learn_btn:"wui-rangeslider-midi-learn-btn"},l={width:148,height:8,title:"",title_min_width:0,value_min_width:0,min:0,max:1,step:.01,scroll_step:.01,vertical:!1,title_on_top:!1,on_change:null,default_value:.5,bar:!0,midi:null,configurable:null},m={min:0,max:0,step:0,scroll_step:0},n=function(a){for(var b,c,d,e=document.getElementById(a),f=null;e;){if(e.classList&&e.classList.contains("wui-dialog")){f=e;break}e=e.parentNode}if(f&&(d=f.getElementsByClassName("wui-dialog-title"),d.length>0&&(c=d[0].innerText||d[0].textContent||"",""!==c&&(b=window.open(null,c))))){if(0!==b.document.body.childElementCount||0!==b.document.head.childElementCount)return b.document.getElementById(a);b.close()}return null},o=function(a){var b=a.ownerDocument,c=a.getBoundingClientRect(),d=b.body,e=b.documentElement,f=b.defaultView||b.parentWindow,g=f.pageYOffset||e.scrollTop||d.scrollTop,h=f.pageXOffset||e.scrollLeft||d.scrollLeft,i=e.clientTop||d.clientTop||0,j=e.clientLeft||d.clientLeft||0,k=c.top+g-i,l=c.left+h-j;return{top:Math.round(k),left:Math.round(l)}},p=function(a,b){null!==a&&a(b)},q=function(a,b){var c=""+a,d=c.indexOf("."),e=-1==d?c.length:1+d+b,f=c.substr(0,e),g=isNaN(f)?0:f;return parseFloat(g)},r=function(a){return a.classList.contains(k.hook)?a:a.classList.contains(k.filler)?a.firstElementChild:a.firstElementChild.firstElementChild},s=function(b,c,d){var e,f,g,h,i=b,j=a[i.id],l=c.opts.width,m=c.opts.height,n=Math.abs((d-c.opts.min)/c.opts.range);e=i.getElementsByClassName(k.bar)[0],f=e.firstElementChild,g=f.firstElementChild,h=e.nextElementSibling,d=q(d,4),c.opts.vertical?(n=Math.round(n*e.offsetHeight),f.style.position="absolute",f.style.bottom="0",f.style.width="100%",f.style.height=n+"px",g.style.marginTop=-l+"px",g.style.marginLeft=-l/2-1+"px",g.style.width=2*l+"px",g.style.height=2*l+"px",h.style.marginTop="13px",j.element!==i&&(j.filler.style.position="absolute",j.filler.style.bottom="0",j.filler.style.width="100%",j.filler.style.height=n+"px",j.hook.style.marginTop=-l+"px",j.hook.style.marginLeft=-l/2-1+"px",j.hook.style.width=2*l+"px",j.hook.style.height=2*l+"px",j.value_input.style.marginTop="13px")):(n=Math.round(n*l),f.style.width=n+"px",f.style.height="100%",g.style.left=n+"px",g.style.marginTop=-m/2+"px",g.style.marginLeft=-m+"px",g.style.width=2*m+"px",g.style.height=2*m+"px",j.element!==i&&(j.filler.style.width=n+"px",j.filler.style.height="100%",j.hook.style.left=n+"px",j.hook.style.marginTop=-m/2+"px",j.hook.style.marginLeft=-m+"px",j.hook.style.width=2*m+"px",j.hook.style.height=2*m+"px")),j.value_input.value=d,h.value=d,c.value=d},t=function(a){if(a.preventDefault(),null!==d){var f,g,h=d.parentElement,i=h.parentElement,j=i.nextElementSibling,k=o(i),l=i.offsetWidth,m=0,n=a.clientX,r=a.clientY,s=a.changedTouches,t=null;if(s)for(f=0;s.length>f;f+=1)if(t=s[f],t.identifier===e){n=s[f].clientX,r=s[f].clientY;break}if(c.opts.vertical?(l=i.offsetHeight,m=Math.round((k.top+i.offsetHeight-r)/c.opts.step)*c.opts.step):m=Math.round((n-k.left)/c.opts.step)*c.opts.step,m>l?(m=l,b=c.opts.max):0>m?(m=0,b=c.opts.min):b=Math.round((c.opts.min+m/l*c.opts.range)/c.opts.step)*c.opts.step,c.value===b)return;c.value=b,g=q(b,4),j.value=g,c.value_input.value=g,c.opts.vertical?(h.style.height=m+"px",c.filler.style.height=m+"px"):(h.style.width=m+"px",c.filler.style.width=m+"px",d.style.left=m+"px",c.hook.style.left=m+"px"),p(c.opts.on_change,b)}},u=function(a){if(d){a.preventDefault();var b,f=a.changedTouches,g=null,h=!1,i=d.ownerDocument,j=i.defaultView||i.parentWindow;if(f){for(b=0;f.length>b;b+=1)if(g=f[b],g.identifier===e){h=!0,j.removeEventListener("touchend",u,!1),j.removeEventListener("touchmove",t,!1);break}}else h=!0,j.removeEventListener("mouseup",u,!1),j.removeEventListener("mousemove",t,!1);h&&(d.classList.remove(k.hook_focus),d=null,c=null,i.body.style.cursor="default")}},v=function(b){b.preventDefault(),b.stopPropagation();var f,g,h=null,i=!1,j=b.changedTouches;null===c&&j&&(e=j[0].identifier,i=!0),0===b.button&&(i=!0),i&&(d=r(b.target),d.classList.add(k.hook_focus),h=d.parentElement.parentElement.parentElement,c=a[h.id],f=h.ownerDocument,g=f.defaultView||f.parentWindow,f.body.style.cursor="pointer",t(b),g.addEventListener("mousemove",t,!1),g.addEventListener("touchmove",t,!1),g.addEventListener("mouseup",u,!1),g.addEventListener("touchend",u,!1))},w=function(b){b.preventDefault(),b.stopPropagation();var c=b.target,d=c.parentElement.parentElement.parentElement,e=a[d.id],f=e.opts.default_value;s(d,e,f),p(e.opts.on_change,f)},x=function(b){b.preventDefault(),b.stopPropagation();var c=r(b.target),d=c.parentElement.parentElement.parentElement,e=a[d.id],f=b.wheelDelta?b.wheelDelta/40:b.detail?-b.detail:0,g=e.value;f>=0?g+=e.opts.scroll_step:g-=e.opts.scroll_step,g>e.opts.max?g=e.opts.max:e.opts.min>g&&(g=e.opts.min),s(d,e,g),p(e.opts.on_change,g)},y=function(b){if(!b.target.validity||b.target.validity.valid){var c=b.target.parentElement.childNodes[1];if(void 0!==c){var d=r(c),e=d.parentElement.parentElement.parentElement,f=a[e.id];s(e,f,b.target.value),p(f.opts.on_change,b.target.value)}}},z=function(a,b,c){return function(a){var d=a.target,e=b.opts;(!d.validity||d.validity.valid)&&("min"===c?(e.min=q(d.value,4),b.value_input.min=e.min,e.range=e.max-e.min):"max"===c?(e.max=q(d.value,4),b.value_input.max=e.max,e.range=e.max-e.min):"step"===c?(e.step=q(d.value,4),b.value_input.step=e.step):"scroll_step"===c&&(e.scroll_step=q(d.value,4)),void 0!==e.configurable[c]&&(e.configurable[c].val=d.value))}},A=function(b){b.preventDefault(),b.stopPropagation();var c,d,e,f,i=b.target,j=i.parentElement,l=a[j.id];if(l.midi.learn)return l.midi.learn=!1,i.style="",void(h=null);for(d in a)a.hasOwnProperty(d)&&(e=a[d],e.midi.learn=!1,c=n(d),c&&(f=c.getElementsByClassName(k.midi_learn_btn),f.length>0&&(f[0].style="")),e.midi.learn_elem&&(e.midi.learn_elem.style=""));l.midi.learn=!0,i.style=g,h=j.id},B=function(b){b.preventDefault(),b.stopPropagation();var c,d,e,g,h,i,j,l,n=b.target,p=n.parentElement,q=a[p.id],r=q.opts,s=n.ownerDocument,t=q.element.id+f,u=1;if(document.getElementById(t)||(q.configure_panel_open=!1),q.configure_panel_open!==!0){h=s.createElement("div"),h.className="wui-rangeslider-configure-container",l=s.createElement("div"),l.className="wui-rangeslider-configure-close",c=function(a){q.configure_panel_open=!1;var b=document.getElementById(t),c=a.target.ownerDocument.getElementById(t);b&&b.parentElement&&b.parentElement.removeChild(b),c&&c.parentElement&&c.parentElement.removeChild(c)},l.addEventListener("click",c,!1),l.addEventListener("touchstart",c,!1),h.id=t,h.appendChild(l);for(e in r.configurable)r.configurable.hasOwnProperty(e)&&void 0!==m[e]&&(g=r.configurable[e],i=s.createElement("div"),i.style.display="inline-block",i.style.marginRight="8px",i.style.width="80px",i.style.textAlign="right",i.innerHTML=e.replace("_"," ")+" : ",j=s.createElement("input"),j.className=k.value_input,h.appendChild(i),h.appendChild(j),u%2===0&&h.appendChild(s.createElement("div")),j.setAttribute("type","number"),void 0!==g&&(void 0!==g.min&&(j.setAttribute("min",g.min),j.title=j.title+" min: "+g.min),void 0!==g.max&&(j.setAttribute("max",g.max),j.title=j.title+" max: "+g.max),void 0!==g.val?j.setAttribute("value",g.val):"min"===e?j.setAttribute("value",r.min):"max"===e?j.setAttribute("value",r.max):"step"===e?j.setAttribute("value",r.step):"scroll_step"===e&&j.setAttribute("value",r.scroll_step)),j.addEventListener("input",z(b,q,e),!1),u+=1);d=o(n),p.insertBefore(h,n),q.configure_panel_open=!0}},C=function(){console.log("WUI_RangeSlider 'create' failed, first argument not an id nor a DOM element.")};this.create=function(b,c){var d,e,f={};if("string"==typeof b)d=document.getElementById(b);else{if("object"!=typeof b)return void C();if("string"!=typeof b.innerHTML)return void C();d=b,b=d.id}if(void 0!==a[b])return void console.log("WUI_RangeSlider id '"+b+"' already created, aborting.");for(e in l)l.hasOwnProperty(e)&&(f[e]=l[e]);if(void 0!==c){for(e in c)c.hasOwnProperty(e)&&void 0!==l[e]&&(f[e]=c[e]);void 0!==c.max&&(f.range=c.max),void 0!==c.step&&(f.step=c.step,void 0===c.scroll_step&&(f.scroll_step=f.step)),void 0!==c.title_on_top?f.title_on_top=c.title_on_top:f.vertical&&(f.title_on_top=!0),void 0!==c.default_value?f.default_value=c.default_value:void 0!==c.min&&void 0!==c.max&&(f.default_value=f.min+f.max/2)}0>f.min&&(f.range=f.max-f.min),a[b]=null,d.classList.add("wui-rangeslider"),f.title_on_top&&d.classList.add("wui-rangeslider-title-ontop");var g=document.createElement("div"),h=document.createElement("div"),i=document.createElement("div"),n=document.createElement("div"),o=document.createElement("div"),p=document.createElement("input"),q={element:d,opts:f,bar:null,filler:null,hook:null,endless:!1,midi:{device:null,controller:null,ctrl_type:"abs",learn:!1,learn_elem:null},value_input:p,value:f.default_value};if(g.innerHTML=f.title,p.setAttribute("value",f.default_value),p.setAttribute("type","number"),p.setAttribute("step",f.step),p.classList.add(k.value_input),o.classList.add("wui-rangeslider-value"),g.classList.add("wui-rangeslider-title"),h.classList.add(k.bar),i.classList.add(k.filler),n.classList.add(k.hook),f.vertical&&(g.style.textAlign="center"),g.style.minWidth=f.title_min_width+"px",o.style.minWidth=f.value_min_width+"px",p.style.minWidth=f.value_min_width+"px",h.style.width=f.width+"px",h.style.height=f.height+"px",d.appendChild(g),f.bar?(p.setAttribute("min",f.min),p.setAttribute("max",f.max)):(h.style.display="none",p.style.marginTop="6px",c.max&&p.setAttribute("min",f.min),c.min&&p.setAttribute("max",f.max)),h.appendChild(i),i.appendChild(n),d.appendChild(h),q.bar=h,q.filler=i,q.hook=n,d.appendChild(p),c.max||c.min||(q.endless=!0),f.configurable){var r=0;for(e in f.configurable)f.configurable.hasOwnProperty(e)&&void 0!==m[e]&&(r+=1);if(r>0){var t=document.createElement("div");t.classList.add("wui-rangeslider-configurable-btn"),t.addEventListener("click",B,!1),t.addEventListener("touchstart",B,!1),f.title_on_top&&!f.vertical?(t.style.bottom="0",g.style.marginBottom="4px"):f.title_on_top&&f.vertical?(g.style.marginLeft="16px",g.style.marginRight="16px",t.style.top="0"):(g.style.marginLeft="16px",t.style.top="0"),f.vertical?d.appendChild(t):d.insertBefore(t,g)}}if(f.midi)if(navigator.requestMIDIAccess){var u=document.createElement("div");u.classList.add(k.midi_learn_btn),u.title=j.midi_learn_btn,u.addEventListener("click",A,!1),u.addEventListener("touchstart",A,!1),q.midi.learn_elem=u,f.midi.type&&(q.midi.ctrl_type=f.midi.type),d.appendChild(u)}else console.log("WUI_RangeSlider id '"+b+"' : Web MIDI API is disabled. (not supported by your browser?)");return f.bar&&(h.addEventListener("mousedown",v,!1),h.addEventListener("touchstart",v,!1),n.addEventListener("dblclick",w,!1),h.addEventListener("mousewheel",x,!1),h.addEventListener("DOMMouseScroll",x,!1)),p.addEventListener("input",y,!1),a[b]=q,s(d,q,f.default_value),b},this.destroy=function(b){var c,d,e,g=a[b];return void 0===g?void console.log("Element id '"+b+"' is not a WUI_RangeSlider, destroying aborted."):(h===b&&(midi_learn_current=null),c=g.element,c.parentElement.removeChild(c),d=c.ownerDocument,e=d.getElementById(b+f),e&&d.removeChild(e),void delete a[b])},this.submitMIDIMessage=function(b){var c,d,e,f,g,l,m=h,o=b.data[0],q=b.data[1],r=parseInt(b.data[2],10),t="d"+o,u="c"+q,v=0;if(h)return c=a[m],i[t]||(i[t]={}),i[t][u]||(i[t][u]={prev_value:r,widgets:[],increments:1}),i[t][u].widgets.push(m),g=n(m),g&&(e=g.getElementsByClassName(k.midi_learn_btn),e.length>0&&(e[0].style="",e[0].title=j.midi_learn_btn)),c.midi.learn=!1,c.midi.learn_elem.style="",c.midi.learn_elem.title=t+" "+u,void(h=null);if(i[t]&&i[t][u])for(d=i[t][u],v=0;d.widgets.length>v;v+=1)if(m=d.widgets[v],c=a[m],g=n(m),f=g?g:c.element,"abs"===c.midi.ctrl_type)l=c.opts.min+c.opts.range*(r/127),s(f,c,l),p(c.opts.on_change,l);else if("rel"===c.midi.ctrl_type){if(d.prev_value>r){if(d.increments=-c.opts.step,l=c.value-c.opts.step,c.opts.min>l&&!c.endless)continue;d.prev_value=r}else if(r>d.prev_value){if(d.increments=c.opts.step,l=c.value+c.opts.step,l>c.opts.max&&!c.endless)continue;d.prev_value=r}else if(l=c.value+d.increments,!c.endless){if(l>c.opts.max)continue;if(c.opts.min>l)continue}s(f,c,l),p(c.opts.on_change,l)}}},WUI_Input=WUI_RangeSlider;